/*
 *  jquery-async-navigator - v0.0.33
 *  Provides async navigation to legacy browser request/loading based websites.
 *  https://github.com/electblake/jquery-async-navigator
 *
 *  Made by Blake E
 *  Under MIT License
 */
!function(a,b,c,d){"use strict";function e(b,c){this.element=jQuery(b),this.settings=a.extend({},i,c),this._defaults=i,this._name=h,jQuery("body").find("#async-nav-assets")[0]||jQuery("body").append('<div style="display:none" id="async-nav-assets"></div>'),this.inject_point=jQuery("body #async-nav-assets"),this.settings.verbose&&(console.log("config script_inject_style=",this.settings.script_inject_style),console.log("config style_inject_style=",this.settings.style_inject_style)),this.current_job=null,this.init()}function f(a){for(var b=d.getElementsByTagName("script"),c=b.length;c--;)if(b[c].src===a)return!0;return!1}function g(b){if(!b)return!0;var c=!1;return a('link[rel="stylesheet"][type="text/css"]').each(function(){a(this).attr("href")===b&&(c=!0)}),c}var h="asyncNavigator",i={load_scripts:!1,inline_styles:!0,load_styles:!0,data_attrs:!1,body_class:!0,script_inject_style:"basic",style_inject_style:"basic",cleanup_styles:!1,animate:!0,verbose:!1,beforeAnimate:null,afterAnimate:null};a.extend(e.prototype,{init:function(){if(this.settings.selector="#"+this.element.attr("id"),b.history){var a=c._.bind(function(){try{if(event){var a;console.log("event.state",event.state),event.state&&event.state.state&&(a=event.state.state),a?(this.settings.verbose&&console.log("poped state",a),this.asyncNextPage(a,{popstate:!0},function(a){a&&console.error(a)})):(this.settings.verbose&&console.log("could not find popstate in event, using history.go(-1)",event),history.go(0))}}catch(b){b&&console.error(b)}},this);c.onpopstate=a}},asyncNextPage:function(b,e,f){this.current_job&&this.current_job.abort(),"function"==typeof e&&(f=e,e={});var g=this.settings,h=this,i=[],j=[function(b){var c=g;c.beforeAnimate?(c.verbose&&console.log("beforeAnimate:start"),c.beforeAnimate(a(c.selector),c,function(){c.verbose&&console.log("beforeAnimate:done"),b()})):c.animate&&h.element.animate({opacity:0},1e3,"ease",function(){b()})},function(f){var j=function(b,j){g.verbose&&(console.log("asyncNavigator:nextPage",j),console.log("asyncNavigator:selector",g.selector)),a(g.selector).html(j.main_content),i=h.inject_point.children(),console.log("previous_async_assets",i),i=i.add(a("head .async-asset")),j.body_class&&(a("body")[0].className=j.body_class),j.page_title&&a("html head title").attr("innerHTML",j.page_title),j.data_attrs.body&&g.data_attrs&&a("body").data(j.data_attrs.body),j.data_attrs.html&&g.data_attrs&&a("html").data(j.data_attrs.html),g.load_styles&&h.load_styles(j),g.inline_styles&&h.inline_styles(j),e&&e.popstate||(history&&history.pushState?(g.verbose&&console.log("pushState",{state:j.url}),history.pushState({state:j.url},j.page_title,j.url)):(g.verbose&&console.log("pushState","not supported."),c.location.hash=j.url)),g.load_scripts?h.load_scripts(j,function(){a(d).ready(function(){f()})}):a(d).ready(function(){f()})};h.getNextPage(b,j)}];c.async.series(j,function(){g.afterAnimate?(console.log("afterAnimate:start"),g.afterAnimate(a(g.selector),g,function(){console.log("afterAnimate:next"),i.remove(),f()})):g.animate&&h.element.animate({opacity:1},500,"swing",function(){f()})})},getNextPage:function(b,d){var e=this.settings;e.verbose&&console.log("getNextPage",b);var f={url:b};this.current_job=a.ajax({url:b,success:c._.bind(function(b){b=b.replace("<body",'<div id="body"'),b=b.replace("</body","</div");var c=a(b),g=c.find(e.selector).attr("innerHTML");g&&g.length>0&&(f.page_title=c.filter("title").text(),f.body_class=c.filter("#body")[0].className,e.verbose&&console.log("scrape: body_class=",f.body_class),f.main_content=g,f.data_attrs={html:c.filter("html").data(),body:c.filter("#body").data()},e.load_scripts&&(f.scripts=c.filter("script").toArray()),e.load_styles&&(f.styles=c.filter('link[rel="stylesheet"]').toArray()),e.inline_styles&&(f.inline_styles=c.filter('style[type="text/css"]').toArray())),d(null,f)},this),error:function(a,b,c){e.verbose&&console.log("status",b),d(c)}})},load_scripts:function(a,b){this.settings.verbose&&console.log("scripts: discovered=",a.scripts.length);var c,e,g=_.bind(function(a){var b=d.createElement("script");b.src=a,this.settings.verbose&&console.log("scripts: ..inject=",b.src),this.inject_point.append(b)},this);if(this.settings.verbose&&console.log("scripts: inject style=",this.settings.script_inject_style),this.settings.script_inject_style&&"merge"===this.settings.script_inject_style)for(var h=a.scripts.length-1;h>=0;h--)e=a.scripts[h],c=e.src,f(c)?this.settings.verbose:g(c);else this.inject_point.append(a.scripts);return b?b(null,a):a},load_styles:function(b,e){if(this.settings.verbose&&console.log("styles: discovered=",b.styles.length),this.settings.style_inject_style&&"merge"===this.settings.style_inject_style){if(this.settings.cleanup_styles){var f=a("link.async-injected");f.remove(),this.settings.verbose&&console.log("cleaned up",f.length)}for(var h=b.styles.length-1;h>=0;h--){var i=b.styles[h],j=i.href;if(g(j))this.settings.verbose;else{var k;c.document.createStyleSheet?(this.settings.verbose&&console.log("styles: ie, inject <head>=",j),k=d.createElement("link"),k.type="text/css",k.rel="stylesheet",k.href=j,k["class"]="async-injected",a("head").append(k)):(k=d.createElement("link"),k.type="text/css",k.rel="stylesheet",k.href=j,this.settings.verbose&&console.log("styles: inject=",k.href),this.inject_point.append(k))}}}else a("body").append(b.styles);return e?e(null,b):b},inline_styles:function(b,e){var f=this.settings;f.verbose&&console.log("inline: discovered=",b.inline_styles.length);var g=function(a){var b=d.getElementsByTagName("head")[0],c=d.createElement("style");c.setAttribute("type","text/css"),c.styleSheet?c.styleSheet.cssText=a:c.appendChild(d.createTextNode(a)),b.appendChild(c),f.verbose&&console.log("inline: cross_browser_addcss",a.substr(0,15))};if(a("body").hasClass("ie")){if(console.log("inline: IE detected","IE support is experimental."),b.inline_styles)for(var h=function(b){console.log("inline_inject_styles_IE9"),a("<div />",{html:"&shy;<style>"+b+"</style>"}).appendTo("body")},i=b.inline_styles.length-1;i>=0;i--){var j=b.inline_styles[i],k=a(j).attr("innerHTML");k=k.replace("<!--/*--><![CDATA[/*><!--*/",""),k=k.replace("/*]]>*/-->",""),k=k.trim(),f.verbose&&console.log("inline: inject=",k.substr(0,100)),c.document.createStyleSheet?h(k):a("body").hasClass("ie11")&&g(k)}}else{var l;f.verbose;for(var m=b.inline_styles.length-1;m>=0;m--){var n=a(b.inline_styles[m]);l=a(n).attr("innerHTML"),l=l.replace("<!--/*--><![CDATA[/*><!--*/",""),l=l.replace("/*]]>*/-->",""),l=l.trim(),l=l;var o='<style class="async-asset">'+l+"</style>";f.verbose&&console.log("inline: inject=",o.substr(0,100)),a("head").append(o)}f.verbose&&console.log(b.inline_styles)}return e?e(null,b):b}}),a.fn[h]=function(b){return this.each(function(){a.data(this,"plugin_"+h)||a.data(this,"plugin_"+h,new e(this,b))})}}(jQuery,Modernizr,window,document);