/*
 *  jquery-async-navigator - v0.0.15
 *  Provides async navigation to legacy browser request/loading based websites.
 *  https://github.com/electblake/jquery-async-navigator
 *
 *  Made by Blake E
 *  Under MIT License
 */
!function(a,b,c){"use strict";function d(b,c){this.element=jQuery(b),this.settings=a.extend({},h,c),this._defaults=h,this._name=g,jQuery("body").find("#async-nav-assets")[0]||jQuery("body").append("<div style='display:none' id='async-nav-assets'></div>"),this.inject_point=jQuery("body #async-nav-assets"),this.init()}function e(a){for(var b=c.getElementsByTagName("script"),d=b.length;d--;)if(b[d].src===a)return!0;return console.debug("script not found",a),!1}function f(b){if(!b)return!0;var c=!1;return a("link[rel='stylesheet'][type='text/css']").each(function(){a(this).attr("href")===b&&(c=!0)}),c}var g="asyncNavigator",h={load_scripts:!1,inline_styles:!0,load_styles:!0,script_inject_style:"basic",style_inject_mode:"basic",animate:!0,verbose:!1,beforeAnimate:null,afterAnimate:null};a.extend(d.prototype,{init:function(){this.settings.selector="#"+this.element.attr("id");var a=b._.bind(function(){try{var a=event.state.state;this.settings.verbose&&console.debug("poped state",a),a&&this.asyncNextPage(a,{popstate:!0},function(a){a&&console.error(a)})}catch(b){b&&console.error(b)}},this);b.onpopstate=a},asyncNextPage:function(c,d,e){"function"==typeof d&&(e=d,d={}),this.settings.animate&&this.element.animate({opacity:0},1e3),this.getNextPage(c,b._.bind(function(b,c){a(this.settings.selector).html(c.main_content),this.inject_point.html(""),this.settings.verbose&&(console.debug("asyncNavigator:nextPage",c),console.debug("asyncNavigator:selector",this.settings.selector)),c.body_class&&(a("body")[0].className=c.body_class),c.page_title&&a("html head title").attr("innerHTML",c.page_title),this.settings.load_styles&&this.load_styles(c),this.settings.inline_styles&&this.inline_styles(c),this.settings.verbose&&console.debug("pushState",{state:c.url}),d&&d.popstate||history.pushState({state:c.url},c.page_title,c.url),this.settings.animate&&setTimeout(_.bind(function(){this.element.animate({opacity:1},500)},this),500),this.settings.load_scripts&&setTimeout(_.bind(function(){this.load_scripts(c)},this),50),e(b)},this))},getNextPage:function(c,d){this.settings.verbose&&console.debug("getNextPage",c);var e={url:c};a.ajax({url:c,success:b._.bind(function(b){b=b.replace("<body","<div id='body'"),b=b.replace("</body","</div");var c=a(b),f=c.find(this.settings.selector).attr("innerHTML");f&&f.length>0&&(e.page_title=c.filter("title").text(),e.body_class=c.filter("#body").attr("class"),e.main_content=f,this.settings.load_scripts&&(e.scripts=c.filter("script").toArray()),this.settings.load_styles&&(e.styles=c.filter("link").toArray()),this.settings.inline_styles&&(e.inline_styles=c.filter("style[type='text/css']").toArray())),d(null,e)},this),error:function(a,b,c){this.settings.verbose&&console.debug("status",b),d(c)}})},load_scripts:function(b,d){this.settings.verbose&&console.debug("Discovered scripts",b.scripts.length);var f,g,h=_.bind(function(a){var b=c.createElement("script");b.src=a,this.settings.verbose&&console.debug("..Injecting script",b),this.inject_point.append(b)},this);if(this.settings.script_inject_style&&"merge"===this.settings.script_inject_style)for(var i=b.scripts.length-1;i>=0;i--)g=b.scripts[i],f=g.src,e(f)||h(f);else a("body").append(b.scripts);return d?d(null,b):b},load_styles:function(b,d){if(this.settings.verbose&&console.debug("Discovered styles",b.styles.length),this.settings.style_inject_mode&&"merge"===this.settings.style_inject_mode)for(var e=b.styles.length-1;e>=0;e--){var g=b.styles[e],h=g.href;!f(h);var i=c.createElement("link");i.type="text/css",i.rel="stylesheet",i.href=h,this.settings.verbose&&console.debug("..injecting style",i),this.inject_point.append(i)}else a("body").append(b.styles);return d?d(null,b):b},inline_styles:function(a,b){return this.settings.verbose&&console.debug("Discovered inline styles",a.inline_styles.length),this.inject_point.append(a.inline_styles),b?b(null,a):a}}),a.fn[g]=function(b){return this.each(function(){a.data(this,"plugin_"+g)||a.data(this,"plugin_"+g,new d(this,b))})}}(jQuery,window,document);