/*
 *  jquery-async-navigator - v0.0.21
 *  Provides async navigation to legacy browser request/loading based websites.
 *  https://github.com/electblake/jquery-async-navigator
 *
 *  Made by Blake E
 *  Under MIT License
 */
!function(a,b,c){"use strict";function d(b,c){this.element=jQuery(b),this.settings=a.extend({},h,c),this._defaults=h,this._name=g,jQuery("body").find("#async-nav-assets")[0]||jQuery("body").append('<div style="display:none" id="async-nav-assets"></div>'),this.inject_point=jQuery("body #async-nav-assets"),this.settings.verbose&&(console.log("config script_inject_style=",this.settings.script_inject_style),console.log("config style_inject_style=",this.settings.style_inject_style)),this.init()}function e(a){for(var b=c.getElementsByTagName("script"),d=b.length;d--;)if(b[d].src===a)return!0;return!1}function f(b){if(!b)return!0;var c=!1;return a('link[rel="stylesheet"][type="text/css"]').each(function(){a(this).attr("href")===b&&(c=!0)}),c}var g="asyncNavigator",h={load_scripts:!1,inline_styles:!0,load_styles:!0,data_attrs:!1,body_class:!0,script_inject_style:"basic",style_inject_style:"basic",cleanup_styles:!1,animate:!0,verbose:!1,beforeAnimate:null,afterAnimate:null};a.extend(d.prototype,{init:function(){this.settings.selector="#"+this.element.attr("id");var a=b._.bind(function(){try{var a=event.state.state;this.settings.verbose&&console.log("poped state",a),a&&this.asyncNextPage(a,{popstate:!0},function(a){a&&console.error(a)})}catch(b){b&&console.error(b)}},this);b.onpopstate=a},asyncNextPage:function(d,e,f){"function"==typeof e&&(f=e,e={});var g=[_.bind(function(b){var c=this.settings;c.beforeAnimate?(c.verbose&&console.log("beforeAnimate:start"),c.beforeAnimate(a(c.selector),c,function(){c.verbose&&console.log("beforeAnimate:done"),b()})):c.animate&&this.element.animate({opacity:0},1e3,"ease",function(){b()})},this),_.bind(function(f){var g=function(d,g){a(this.settings.selector).html(g.main_content),this.inject_point.html(""),this.settings.verbose&&(console.log("asyncNavigator:nextPage",g),console.log("asyncNavigator:selector",this.settings.selector)),g.body_class&&(a("body")[0].className=g.body_class),g.page_title&&a("html head title").attr("innerHTML",g.page_title),g.data_attrs.body&&this.settings.data_attrs&&a("body").data(g.data_attrs.body),g.data_attrs.html&&this.settings.data_attrs&&a("html").data(g.data_attrs.html),this.settings.load_styles&&this.load_styles(g),this.settings.inline_styles&&this.inline_styles(g),e&&e.popstate||(history&&history.pushState?(this.settings.verbose&&console.log("pushState",{state:g.url}),history.pushState({state:g.url},g.page_title,g.url)):(this.settings.verbose&&console.log("pushState","not supported."),b.location.hash=g.url)),this.settings.load_scripts&&this.load_scripts(g),a(c).ready(function(){f()})};this.getNextPage(d,b._.bind(g,this))},this)];b.async.series(g,b._.bind(function(){this.settings.afterAnimate?(console.log("afterAnimate:start"),this.settings.afterAnimate(a(this.settings.selector),this.settings,function(){console.log("afterAnimate:next"),f()})):this.settings.animate&&this.element.animate({opacity:1},500,"swing",function(){f()})},this))},getNextPage:function(c,d){this.settings.verbose&&console.log("getNextPage",c);var e={url:c};a.ajax({url:c,success:b._.bind(function(b){b=b.replace("<body",'<div id="body"'),b=b.replace("</body","</div");var c=a(b),f=c.find(this.settings.selector).attr("innerHTML");f&&f.length>0&&(e.page_title=c.filter("title").text(),e.body_class=c.filter("#body").attr("class"),e.main_content=f,e.data_attrs={html:c.filter("html").data(),body:c.filter("#body").data()},this.settings.load_scripts&&(e.scripts=c.filter("script").toArray()),this.settings.load_styles&&(e.styles=c.filter('link[rel="stylesheet"]').toArray()),this.settings.inline_styles&&(e.inline_styles=c.filter('style[type="text/css"]').toArray())),d(null,e)},this),error:function(a,b,c){this.settings.verbose&&console.log("status",b),d(c)}})},load_scripts:function(b,d){this.settings.verbose&&console.log("scripts: discovered=",b.scripts.length);var f,g,h=_.bind(function(a){var b=c.createElement("script");b.src=a,this.settings.verbose&&console.log("scripts: ..inject=",b.src),this.inject_point.append(b)},this);if(this.settings.verbose&&console.log("scripts: inject style=",this.settings.script_inject_style),this.settings.script_inject_style&&"merge"===this.settings.script_inject_style)for(var i=b.scripts.length-1;i>=0;i--)g=b.scripts[i],f=g.src,e(f)?this.settings.verbose:h(f);else a("body").append(b.scripts);return d?d(null,b):b},load_styles:function(d,e){if(this.settings.verbose&&console.log("styles: discovered=",d.styles.length),this.settings.style_inject_style&&"merge"===this.settings.style_inject_style){if(this.settings.cleanup_styles){var g=a("link.async-injected");g.remove(),this.settings.verbose&&console.log("cleaned up",g.length)}for(var h=d.styles.length-1;h>=0;h--){var i=d.styles[h],j=i.href;if(f(j))this.settings.verbose;else{var k;b.document.createStyleSheet?(this.settings.verbose&&console.log("styles: ie, inject <head>=",j),k=c.createElement("link"),k.type="text/css",k.rel="stylesheet",k.href=j,k["class"]="async-injected",a("head").append(k)):(k=c.createElement("link"),k.type="text/css",k.rel="stylesheet",k.href=j,this.settings.verbose&&console.log("styles: inject=",k.href),this.inject_point.append(k))}}}else a("body").append(d.styles);return e?e(null,d):d},inline_styles:function(c,d){if(this.settings.verbose&&console.log("inline: discovered=",c.inline_styles.length),b.document.createStyleSheet){if(console.log("document.createStyleSheet detected","IE support is experimental!"),c.inline_styles)for(var e=function(b){console.log("inline_inject_styles_IE9"),a("<div />",{html:"&shy;<style>"+b+"</style>"}).appendTo("body")},f=c.inline_styles.length-1;f>=0;f--){var g=c.inline_styles[f],h=a(g).attr("innerHTML");h=h.replace("<!--/*--><![CDATA[/*><!--*/",""),h=h.replace("/*]]>*/-->",""),h=h.trim(),this.settings.verbose&&console.log("inline: inject=",h.substr(0,100)),e(h)}}else this.inject_point.append(c.inline_styles);return d?d(null,c):c}}),a.fn[g]=function(b){return this.each(function(){a.data(this,"plugin_"+g)||a.data(this,"plugin_"+g,new d(this,b))})}}(jQuery,window,document);